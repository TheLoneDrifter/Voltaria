name: Build Terraria (Windows)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository ‚úÖ
        uses: actions/checkout@v4

      - name: Print runner info üîç
        shell: powershell
        run: |
          Write-Host "Runner: $env:RUNNER_OS"
          if (Get-Command msbuild -ErrorAction SilentlyContinue) {
            Write-Host "msbuild found in PATH"
            msbuild -version
          } else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { Write-Host "MSBuild discovered via vswhere: $ms"; & $ms /version } else { Write-Host "msbuild not found via vswhere" }
            } else {
              Write-Host "vswhere not found and msbuild not in PATH"
            }
          }

      - name: Try to install XNA (Chocolatey) ‚ö†Ô∏è
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host 'Attempting to install XNA 4.0 via Chocolatey (best-effort)...'
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            try {
              choco install xna -y
            } catch {
              Write-Host 'xna package failed; trying xna4...'
              try { choco install xna4 -y } catch { Write-Host 'xna installs failed; build may still fail.' }
            }
          } else {
            Write-Host 'Chocolatey not found; skipping XNA install.'
          }

      - name: Restore NuGet packages üì¶
        run: nuget restore Terraria.sln

      - name: Locate MSBuild üîé
        id: find-msbuild
        shell: powershell
        run: |
          $msbuildPath = ''
          if (Get-Command msbuild -ErrorAction SilentlyContinue) { $msbuildPath = (Get-Command msbuild).Source }
          else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { $msbuildPath = $ms }
            }
          }
          if ([string]::IsNullOrEmpty($msbuildPath)) { Write-Host "msbuild_path=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append; Write-Host 'MSBuild not found.' }
          else { Write-Host "msbuild_path=$msbuildPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append; Write-Host "MSBuild path set to $msbuildPath" }

      - name: Build with MSBuild üîß
        shell: powershell
        run: |
          $msbuildPath = '${{ steps.find-msbuild.outputs.msbuild_path }}'
          if (-not [string]::IsNullOrEmpty($msbuildPath)) {
            & $msbuildPath 'Terraria.sln' '/p:Configuration=Release' '/m' | Tee-Object -FilePath build.log
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          } else {
            Write-Error 'MSBuild executable not found. Aborting build.'
            exit 1
          }

      - name: Upload build log üßæ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - name: Upload compiled binary (if present) üì§
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraria-bin
          path: Terraria/bin/Release/
