name: Build Terraria (Windows)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository ‚úÖ
        uses: actions/checkout@v4

      - name: Print runner info üîç
        shell: powershell
        run: |
          Write-Host "Runner: $env:RUNNER_OS"
          if (Get-Command msbuild -ErrorAction SilentlyContinue) {
            Write-Host "msbuild found in PATH"
            msbuild -version
          } else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { Write-Host "MSBuild discovered via vswhere: $ms"; & $ms /version } else { Write-Host "msbuild not found via vswhere" }
            } else {
              Write-Host "vswhere not found and msbuild not in PATH"
            }
          }

      - name: Try to install XNA (Chocolatey) ‚ö†Ô∏è
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host 'Attempting to install XNA 4.0 via Chocolatey (best-effort)...'
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            try {
              choco install xna -y
            } catch {
              Write-Host 'xna package failed; trying xna4...'
              try { choco install xna4 -y } catch { Write-Host 'xna installs failed; build may still fail.' }
            }
          } else {
            Write-Host 'Chocolatey not found; skipping XNA install.'
          }

      - name: Install .NET Framework 4.0 Targeting Pack (Developer Pack) üì•
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host 'Attempting to install .NET Framework 4.0 Developer/Targeting Pack (best-effort)...'

          # 1) Try Chocolatey (if available)
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            Write-Host 'Trying Chocolatey packages...'
            choco install netfx -y || choco install dotnet4 -y || choco install dotnetfx -y || Write-Host 'No suitable choco package available or install failed.'
          } else { Write-Host 'Chocolatey not available; skipping choco step.' }

          # 2) Try official Microsoft offline installer for .NET 4.0
          $url = 'https://download.microsoft.com/download/1/1/6/116D46CE-6D1F-40FE-A1D9-902B0A0AA8BC/dotNetFx40_Full_x86_x64.exe'
          $out = "$env:TEMP\dotnetfx40.exe"
          Write-Host "Downloading $url to $out..."
          try { Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing -ErrorAction Stop } catch { Write-Host 'Download failed or blocked.' }
          if (Test-Path $out) {
            Write-Host 'Running .NET 4.0 installer (quiet)...'
            Start-Process -FilePath $out -ArgumentList '/q' -Wait -NoNewWindow -ErrorAction SilentlyContinue
          }

          # 3) Verify install by checking Reference Assemblies location
          $refPath = 'C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.0'
          if (Test-Path $refPath) { Write-Host "Targeting pack present at $refPath" } else { Write-Host "Targeting pack NOT found at $refPath after attempts" }

      - name: Restore NuGet packages üì¶
        run: nuget restore Terraria.sln

      - name: Locate and build with MSBuild üîéüîß
        shell: powershell
        run: |
          $msbuildPath = ''
          if (Get-Command msbuild -ErrorAction SilentlyContinue) { $msbuildPath = (Get-Command msbuild).Source }
          else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { $msbuildPath = $ms }
            }
          }
          if (-not [string]::IsNullOrEmpty($msbuildPath)) {
            Write-Host "MSBuild: $msbuildPath"
            & $msbuildPath 'Terraria.sln' '/p:Configuration=Release' '/m' | Tee-Object -FilePath build.log
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          } else {
            Write-Error 'MSBuild executable not found. Aborting build.'
            exit 1
          }

      - name: Upload build log üßæ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - name: Upload compiled binary (if present) üì§
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraria-bin
          path: Terraria/bin/Release/
