name: Build Terraria (Windows)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository ‚úÖ
        uses: actions/checkout@v4

      - name: Print runner info üîç
        shell: powershell
        run: |
          Write-Host "Runner: $env:RUNNER_OS"
          if (Get-Command msbuild -ErrorAction SilentlyContinue) {
            Write-Host "msbuild found in PATH"
            msbuild -version
          } else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { Write-Host "MSBuild discovered via vswhere: $ms"; & $ms /version } else { Write-Host "msbuild not found via vswhere" }
            } else {
              Write-Host "vswhere not found and msbuild not in PATH"
            }
          }

      - name: Populate lib with XNA assemblies (best-effort) üì¶
        shell: powershell
        continue-on-error: true
        run: |
          $libDir = Join-Path $env:GITHUB_WORKSPACE 'lib'
          if (-not (Test-Path $libDir)) { New-Item -ItemType Directory -Path $libDir | Out-Null }

          $copied = $false
          $possiblePaths = @(
            "$env:ProgramFiles(x86)\Microsoft XNA\XNA Game Studio\References\Windows\x86",
            "$env:ProgramFiles(x86)\Microsoft XNA\XNA Game Studio\References\Windows",
            "$env:ProgramFiles(x86)\Reference Assemblies\Microsoft\Framework\XNA",
            "$env:ProgramFiles(x86)\Reference Assemblies\Microsoft\Framework\XNA\v4.0"
          )

          foreach ($p in $possiblePaths) {
            if (Test-Path $p) {
              Write-Host "Found XNA reference folder: $p"
              Copy-Item "$p\*.dll" -Destination $libDir -Force -ErrorAction SilentlyContinue
              $copied = $true
              break
            }
          }

          if (-not $copied -and (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host 'Attempting chocolatey install of XNA (best-effort)...'
            try {
              & choco install xna -y
              if ($LASTEXITCODE -ne 0) { throw 'xna install failed' }
            } catch {
              Write-Host 'xna package failed; trying xna4...'
              try { & choco install xna4 -y; if ($LASTEXITCODE -ne 0) { throw 'xna4 install failed' } } catch {
                Write-Host 'xna4 failed; trying xna-4.0...'
                try { & choco install xna-4.0 -y } catch { Write-Host 'xna installs failed; build may still fail.' }
              }
            }
            foreach ($p in $possiblePaths) { if (Test-Path $p) { Copy-Item "$p\*.dll" -Destination $libDir -Force -ErrorAction SilentlyContinue; $copied = $true; break } }
          }

          if (-not $copied) {
            Write-Host 'Attempting to download XNA redistributable (best-effort)'
            $urls = @(
              'https://download.microsoft.com/download/a/c/2/ac2c903b-e6e8-42c2-9fd7-bebac362a930/xnafx40_redist.msi'
            )
            foreach ($u in $urls) {
              try {
                $msi = Join-Path $env:TEMP 'xna_redist.msi'
                Invoke-WebRequest -Uri $u -OutFile $msi -UseBasicParsing -ErrorAction Stop
                $extractDir = Join-Path $env:TEMP 'xna_extract'
                if (Test-Path $extractDir) { Remove-Item $extractDir -Recurse -Force }
                msiexec /a $msi /qn TARGETDIR=$extractDir
                $dllNames = @(
                  'Microsoft.Xna.Framework.dll',
                  'Microsoft.Xna.Framework.Game.dll',
                  'Microsoft.Xna.Framework.Graphics.dll',
                  'Microsoft.Xna.Framework.Xact.dll'
                )
                foreach ($dll in $dllNames) {
                  $found = Get-ChildItem -Path $extractDir -Recurse -Filter $dll | Select-Object -First 1
                  if ($found) { Copy-Item $found.FullName -Destination $libDir -Force -ErrorAction SilentlyContinue }
                }
                if (Test-Path (Join-Path $libDir 'Microsoft.Xna.Framework.dll')) { $copied = $true; break }
              } catch {
                Write-Host "Failed to download/extract from $u"
              }
            }
          }

          if ($copied) { Write-Host 'XNA assemblies placed in lib/'; Get-ChildItem "$libDir\*.dll" | ForEach-Object { Write-Host $_.Name } }
          else { Write-Host 'XNA assemblies not found; build may fail.' }

      - name: Restore NuGet packages üì¶
        run: nuget restore Terraria.sln

      - name: Locate and build with MSBuild üîéüîß
        shell: powershell
        run: |
          $msbuildPath = ''
          if (Get-Command msbuild -ErrorAction SilentlyContinue) { $msbuildPath = (Get-Command msbuild).Source }
          else {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $ms = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\\**\\Bin\\MSBuild.exe | Select-Object -First 1
              if ($ms) { $msbuildPath = $ms }
            }
          }
          if (-not [string]::IsNullOrEmpty($msbuildPath)) {
            Write-Host "MSBuild: $msbuildPath"
            & $msbuildPath 'Terraria.sln' '/p:Configuration=Release' '/m' | Tee-Object -FilePath build.log
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          } else {
            Write-Error 'MSBuild executable not found. Aborting build.'
            exit 1
          }

      - name: Upload build log üßæ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - name: Show build output folder üóÇÔ∏è
        if: always()
        shell: powershell
        run: |
          Write-Host 'Listing bin/Release contents:'
          if (Test-Path 'bin/Release') { Get-ChildItem -Path 'bin/Release' -Recurse | ForEach-Object { Write-Host $_.FullName } } else { Write-Host 'bin/Release not found' }

      - name: Upload compiled binary (if present) üì§
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraria-bin
          path: bin/Release/**
          retention-days: 7
